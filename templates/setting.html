{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>BAIS - Settings</title>
    <link rel="icon" href="{% static 'images/logo.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="main-body">
    {% include 'layout/header.html' %}

    <div class="setting-container">
        <aside class="setting-sidebar">
            <button class="setting-menu-item active" onclick="openTab(event, 'team-tab')">
                <i class="fas fa-tshirt"></i> 선호구단 변경
            </button>
            <button class="setting-menu-item" onclick="openTab(event, 'pw-tab')">
                <i class="fas fa-lock"></i> 비밀번호 변경
            </button>
            <button class="setting-menu-item" onclick="openTab(event, 'sub-tab')">
                <i class="fas fa-credit-card"></i> 구독 정보
            </button>
            <button class="setting-menu-item" onclick="openTab(event, 'del-tab')">
                <i class="fas fa-user-slash"></i> 회원 탈퇴
            </button>
        </aside>

        <main class="setting-content">
            <div id="team-tab" class="setting-section active">
                <h2 class="setting-title">선호 구단 변경</h2>
                
                <div class="setting-team-grid">
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'LG')">
                        <img src="{% static 'images/teams/lg.svg' %}" alt="LG"> <span>LG 트윈스</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'HANWHA')">
                        <img src="{% static 'images/teams/hanwha.svg' %}" alt="HANWHA"> <span>한화 이글스</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'SSG')">
                        <img src="{% static 'images/teams/ssg.svg' %}" alt="SSG"> <span>SSG 랜더스</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'SAMSUNG')">
                        <img src="{% static 'images/teams/smsung.svg' %}" alt="SAMSUNG"> <span>삼성 라이온즈</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'NC')">
                        <img src="{% static 'images/teams/nc.svg' %}" alt="NC"> <span>NC 다이노스</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'KT')">
                        <img src="{% static 'images/teams/kt.svg' %}" alt="KT"> <span>KT 위즈</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'LOTTE')">
                        <img src="{% static 'images/teams/lotte.svg' %}" alt="LOTTE"> <span>롯데 자이언츠</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'KIA')">
                        <img src="{% static 'images/teams/kia.svg' %}" alt="KIA"> <span>KIA 타이거즈</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'DOOSAN')">
                        <img src="{% static 'images/teams/doosan.svg' %}" alt="DOOSAN"> <span>두산 베어스</span>
                    </button>
                    <button class="setting-team-btn" onclick="selectNewTeam(this, 'KIWOOM')">
                        <img src="{% static 'images/teams/kiwoom.svg' %}" alt="KIWOOM"> <span>키움 히어로즈</span>
                    </button>
                </div>

                <button id="updateTeamBtn" class="setting-confirm-btn" onclick="confirmTeamUpdate()">변경 사항 저장</button>
            </div>

            <div id="pw-tab" class="setting-section">
                <h2 class="setting-title">비밀번호 변경</h2>
                <p style="color:#888; margin-bottom: 30px;">비밀번호 변경 완료 후 메인페이지로 이동(로그아웃) 됩니다.</p>

                <div class="setting-input-group">
                    <label class="setting-label">기존 비밀번호 입력</label>
                    <input type="password" id="current_pw" class="setting-input" placeholder="현재 비밀번호를 입력하세요">
                </div>
                <div class="setting-input-group">
                    <label class="setting-label">새 비밀번호 입력</label>
                    <input type="password" id="new_pw" class="setting-input" placeholder="영소문자+숫자 포함 10~16자 이내">
                </div>
                <div class="setting-input-group">
                    <label class="setting-label">새 비밀번호 재입력</label>
                    <input type="password" id="confirm_pw" class="setting-input" placeholder="새 비밀번호를 다시 입력하세요">
                </div>
                <div id="pwErrorMsg" class="setting-error-text"></div>

                <button id="updatePwBtn" class="setting-confirm-btn active" onclick="confirmPwUpdate()">비밀번호 변경</button>
            </div>

            <div id="sub-tab" class="setting-section">
                <h2 class="setting-title">구독 정보</h2>
                
                {% if sub_info.has_sub %}
                    <div class="sub-status-box">
                        <div class="sub-plan-badge">{{ sub_info.plan_name }}</div>
                        <div class="sub-date-info">
                            {{ sub_info.expire_date }}까지 이용할 수 있습니다.<br>
                            {% if sub_info.has_reserved %}
                                <div style="margin-top: 8px;">
                                    <span style="color: #E50914; font-weight: 700;">
                                        ※ {{ sub_info.reserved_start_date }}부터 [{{ sub_info.reserved_plan }}]으로 변경됩니다.
                                    </span><br>
                                    
                                    {% if not sub_info.is_canceled %}
                                        <span style="color: #aaa; font-size: 0.9rem;">
                                            (다음 결제일: {{ sub_info.reserved_next_pay }})
                                        </span>
                                    {% else %}
                                        <span style="color: #aaa; font-size: 0.9rem;">
                                            (변경 후 자동 갱신되지 않습니다.)
                                        </span>
                                    {% endif %}
                                </div>
                            {% elif sub_info.is_canceled %}
                                <span style="color: #aaa;">이후 무료 플랜으로 전환됩니다.</span>
                            {% else %}
                                다음 결제일은 {{ sub_info.next_pay_date }}입니다.
                            {% endif %}
                        </div>
                    </div>

                    <div class="history-container">
                        <div class="history-title">결제 내역</div>
                        <div class="history-header">
                            <span>결제일자</span>
                            <span>결제 금액</span>
                        </div>
                        <div class="history-list">
                            {% for pay in payment_list %}
                            <div class="history-item">
                                <span>{{ pay.payment_date|date:"Y.m.d" }}</span>
                                <div class="history-line"></div>
                                <span>{{ pay.amount_str }}</span>
                            </div>
                            {% empty %}
                            <div style="color:#666; padding:20px;">결제 내역이 없습니다.</div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="sub-actions">
                        {% if sub_info.is_canceled %}
                            <span></span> 
                            <button class="btn-text-white" onclick="proceedRenew()">
                                {% if sub_info.has_reserved %}
                                    예약된 구독 갱신하기
                                {% else %}
                                    구독 플랜 갱신
                                {% endif %}
                            </button>

                        {% elif sub_info.has_reserved %}
                            <button class="btn-text-red" onclick="openCancelModal()">예약된 구독 해지하기</button>
                            <button class="btn-text-white" disabled style="opacity: 0.5; cursor: not-allowed; text-decoration: none;" title="이미 변경 예약이 되어있습니다.">
                                구독 플랜 변경 불가
                            </button>

                        {% else %}
                            <button class="btn-text-red" onclick="openCancelModal()">구독 해지하기</button>
                            <button class="btn-text-white" onclick="openPlanModalFromSetting()">구독 플랜 변경</button>
                        {% endif %}
                    </div>

                {% else %}
                    <div style="text-align: center; padding: 50px 0;">
                        <p style="font-size: 1.2rem; color: #aaa; margin-bottom: 30px;">현재 이용 중인 구독 상품이 없습니다.</p>
                        <button class="setting-confirm-btn active" onclick="location.href='videos/home'" style="max-width:200px; margin:0 auto;">플랜 보러가기</button>
                    </div>
                {% endif %}
            </div>
            
            <div id="del-tab" class="setting-section">
                <h2 class="setting-title" style="color: #E50914;">회원 탈퇴</h2>
                <div style="background: rgba(229, 9, 20, 0.1); border: 1px solid rgba(229, 9, 20, 0.3); padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h4 style="color: #E50914; margin-bottom: 10px; font-size: 1rem; font-weight: 700; margin-top: 0;">⚠ 탈퇴 전 유의사항</h4>
                    <ul style="color: #ccc; font-size: 0.9rem; line-height: 1.8; list-style-type: disc; padding-left: 20px; margin: 0;">
                        <li>탈퇴 시 회원님의 모든 구독 정보와 결제 내역이 영구 삭제됩니다.</li>
                        <li>삭제된 데이터는 복구할 수 없습니다.</li>
                        <li>현재 이용 중인 플랜이 있더라도 환불되지 않으며 즉시 소멸됩니다.</li>
                    </ul>
                </div>

                <div class="setting-input-group">
                    <label class="setting-label">비밀번호 확인</label>
                    <input type="password" id="del_pw" class="setting-input" placeholder="본인 확인을 위해 비밀번호를 입력해주세요">
                </div> 

                <div id="del_error_msg" class="setting-error-text" style="padding-bottom: 10px;"></div>

                <button onclick="requestDeleteAccount()" class="setting-confirm-btn active" 
                        style="background-color: #333; border: 1px solid #555; color: #aaa; margin-top: 10px; box-shadow: none;">
                    회원 탈퇴
                </button>
            </div>
        </main>
    </div>


    <div id="cancelModal" class="modal-overlay" style="display: none;">
        <div class="modal-content cancel-box">
            <div class="cancel-msg">
                <strong>구독 해지 시, 자동으로 갱신되지 않으며<br>
                현재(또는 예약된) 플랜은 {{ sub_info.modal_expire_date }}까지 사용 가능합니다.</strong>
                <br>
                그 이후부터는 무료 플랜으로 자동 전환됩니다.<br>
                업로드 사용 용량 및 해설위원 선택 범위의 제약이 생길 수 있습니다.
            </div>
            
            <div class="cancel-actions">
                <button class="btn-cancel-close" onclick="closeCancelModal()">취소</button>
                <button class="btn-cancel-confirm" onclick="proceedCancel()">해지</button>
            </div>
        </div>
    </div>

    <div id="changePlanModal" class="modal-overlay" style="display: none;">
        <div class="modal-content change-modal-box">
            <span class="close-btn" onclick="closeChangeModal()" style="color: #fff;">&times;</span>
            
            <div class="change-header-text">
                <h2>구독 플랜 변경</h2>
                <p>다른 플랜으로 변경할 경우 <span>내 영상 시청</span>에 있는 영상이 일부 삭제될 수 있습니다.</p>
                <p>플랜을 변경할 경우 <span>다음 구독일</span>부터 플랜이 변경됩니다.</p>
            </div>

            <div class="change-card-container">
                <div class="change-card" id="card-FREE" onclick="selectChangeCard('FREE')">
                    <div class="change-card-title">기본 제공</div>
                    <div class="change-card-price pt10" style="font-size:1rem; color: dimgray; margin-bottom:28px; padding-top: 15px;">월 정기 결제 없음</div>
                    <ul class="change-card-list">
                        <li>해설위원 선택 (3명)</li>
                        <li>영상 시청 (1회)</li>
                    </ul>
                    <p style="font-size:0.8rem; color:#777; margin-top:20px; line-height:1.4;">* 무료 시청은 1회만 가능하며 영상을 클릭하면 소멸됩니다.</p>
                </div>

                <div class="change-card" id="card-BASIC" onclick="selectChangeCard('BASIC')">
                    <div class="change-card-title" style="color:#E50914;">베이직 플랜</div>
                    <div class="change-card-price">4,900원<span>/월</span></div>
                    <ul class="change-card-list">
                        <li>해설위원 선택 (3명)</li>
                        <li>영상 시청 (무제한)</li>
                        <li>영상 업로드 (3GB)</li>
                    </ul>
                </div>

                <div class="change-card" id="card-PREMIUM" onclick="selectChangeCard('PREMIUM')">
                    <div class="change-card-title" style="color:#E50914;">프리미엄 플랜</div>
                    <div class="change-card-price">9,900원<span>/월</span></div>
                    <ul class="change-card-list">
                        <li>해설위원 선택 (3명)</li>
                        <li>영상 시청 (무제한)</li>
                        <li>영상 업로드 (15GB)</li>
                    </ul>
                </div>
            </div>

            <button id="btnChangeSubmit" class="btn-change-submit" onclick="submitChangePlan()" disabled>플랜 변경</button>
        </div>
    </div>

    <div id="deleteBlockModal" class="modal-overlay" style="display: none;">
        <div class="modal-content cancel-box">
            <h2 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 20px; color: #fff;">탈퇴하시겠습니까?</h2>
            <div class="cancel-msg">
                현 계정에서 구독 해지가 되어 있지 않습니다.<br>
                <strong>구독 해지가 완료되어야 탈퇴가 가능합니다.</strong>
            </div>
            <div class="cancel-actions">
                <button class="btn-block-close" onclick="closeBlockModal()">취소</button>
                <button class="btn-block-disabled" disabled>탈퇴</button>
            </div>
        </div>
    </div>
    {% include 'layout/footer.html' %}
</body>
<script>
const currentTeamCode = "{{ user.favorite_code.common_code_value }}";
let selectedTeamCode = null;

window.onload = function() {
    const btns = document.querySelectorAll('.setting-team-btn');
    btns.forEach(btn => {
        const onClickText = btn.getAttribute('onclick');
        if (onClickText.includes(`'${currentTeamCode}'`)) {
            btn.disabled = true;
        }
    });

    const lastTab = localStorage.getItem('lastActiveTab')
    
    if (lastTab) {
        const targetBtn = document.querySelector(`.setting-menu-item[onclick*="'${lastTab}'"]`);
        if (targetBtn) {
            targetBtn.click();
        } else {
            document.querySelector('.setting-menu-item').click();
        }
    } else {
        document.querySelector('.setting-menu-item').click();
    }
};

function openTab(evt, tabName) {
    document.querySelectorAll('.setting-section').forEach(sec => sec.style.display = 'none');
    document.querySelectorAll('.setting-menu-item').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).style.display = 'block';
    evt.currentTarget.classList.add('active');
    localStorage.setItem('lastActiveTab', tabName);
}

function selectNewTeam(el, code) {
    if (code === currentTeamCode) return;
    document.querySelectorAll('.setting-team-btn').forEach(btn => btn.classList.remove('selected'));
    el.classList.add('selected');
    selectedTeamCode = code;
    const confirmBtn = document.getElementById('updateTeamBtn');
    confirmBtn.classList.add('active');
    confirmBtn.disabled = false;
}

function confirmTeamUpdate() {
    if (!selectedTeamCode || selectedTeamCode === currentTeamCode) return;
    fetch('/update_team', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ team_code: selectedTeamCode })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("구단이 변경되었습니다!");
            location.reload(); 
        } else {
            alert(data.message);
        }
    });
}

function confirmPwUpdate() {
    const currentPw = document.getElementById('current_pw').value;
    const newPw = document.getElementById('new_pw').value;
    const confirmPw = document.getElementById('confirm_pw').value;
    const errorMsg = document.getElementById('pwErrorMsg');

    errorMsg.innerText = ""; 

    if (!currentPw || !newPw || !confirmPw) {
        errorMsg.innerText = "모든 정보를 입력해주세요.";
        return;
    }

    if (newPw !== confirmPw) {
        errorMsg.innerText = "새 비밀번호가 일치하지 않습니다.";
        return;
    }

    const regex = /^(?=.*[a-z])(?=.*\d).{10,16}$/;
    if (!regex.test(newPw)) {
        errorMsg.innerText = "영소문자와 숫자를 포함한 10~16자 이내로 입력해주세요.";
        return;
    }

    fetch('/update_password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            current_pw: currentPw,
            new_pw: newPw,
            confirm_pw: confirmPw
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '/';
        } else {
            errorMsg.innerText = data.message;
        }
    })
    .catch(err => {
        errorMsg.innerText = "서버 통신 중 오류가 발생했습니다.";
    });
}

function openCancelModal() {
    const hasSub = "{{ sub_info.has_sub|yesno:'true,false' }}";
    if(hasSub === 'false') {
        alert("해지할 구독 정보가 없습니다.");
        return;
    }
    document.getElementById('cancelModal').style.display = 'flex';
}

function closeCancelModal() {
    document.getElementById('cancelModal').style.display = 'none';
}

function proceedCancel() {
    fetch('payments/cancel_subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(`구독 해지가 완료되었습니다.\n${data.date}까지 이용 가능합니다.`);
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        alert("처리 중 오류가 발생했습니다.");
    });
}

function proceedRenew() {
    if(!confirm("구독 자동 갱신을 다시 시작하시겠습니까?")) return;

    fetch('payments/renew_subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("구독 갱신이 완료되었습니다.\n다음 결제일에 자동으로 결제됩니다.");
            location.reload(); 
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        alert("처리 중 오류가 발생했습니다.");
    });
}

const myCurrentPlan = "{{ sub_info.plan_code|default:'FREE' }}"; 
let targetPlan = null;

function openPlanModalFromSetting() {
    document.getElementById('changePlanModal').style.display = 'flex';
    
    document.querySelectorAll('.change-card').forEach(card => {
        card.classList.remove('active', 'current-plan');
        const planCode = card.id.split('-')[1];
        card.onclick = function() { selectChangeCard(planCode); };
    });

    const currentCard = document.getElementById('card-' + myCurrentPlan);
    if(currentCard) {
        currentCard.classList.add('current-plan');
        currentCard.onclick = null; 
    }
    
    targetPlan = null;
    updateChangeBtn();
}

function closeChangeModal() {
    document.getElementById('changePlanModal').style.display = 'none';
}

function selectChangeCard(planCode) {
    if (planCode === myCurrentPlan) return;
    document.querySelectorAll('.change-card').forEach(card => card.classList.remove('active'));
    document.getElementById('card-' + planCode).classList.add('active');
    targetPlan = planCode;
    updateChangeBtn();
}

function updateChangeBtn() {
    const btn = document.getElementById('btnChangeSubmit');
    
    if (targetPlan && targetPlan !== myCurrentPlan) {
        btn.disabled = false;
        btn.classList.add('active');
    } else {
        btn.disabled = true;
        btn.classList.remove('active');
    }
}

function submitChangePlan() {
    if (!targetPlan) return;

    if (targetPlan === 'FREE') {
        if(confirm("기본 제공(무료) 플랜으로 변경하시겠습니까?\n이 경우 구독 해지 처리되며 만료일까지 이용 후 전환됩니다.")) {
            proceedCancel(); 
        }
    } else {
        if(confirm(`${targetPlan} 플랜으로 변경하시겠습니까?\n결제 페이지로 이동합니다.`)) {
            location.href = "{% url 'payments:sub_ready' %}?plan=" + targetPlan;
        }
    }
}

const isSubscribed = "{{ sub_info.has_sub|yesno:'true,false' }}";
const isCanceled = "{{ sub_info.is_canceled|yesno:'true,false' }}";

function requestDeleteAccount() {
    const pwInput = document.getElementById('del_pw');
    const errorMsg = document.getElementById('del_error_msg');
    const btn = document.querySelector('#del-tab .setting-confirm-btn');
    const password = pwInput.value;

    errorMsg.innerText = "";
    if (!password) {
        errorMsg.innerText = "비밀번호를 입력해주세요.";
        pwInput.focus();
        return;
    }

    if (isSubscribed === 'true' && isCanceled === 'false') {
        document.getElementById('deleteBlockModal').style.display = 'flex';
        return; 
    }

    if (!confirm("정말로 탈퇴하시겠습니까?\n이 동작은 되돌릴 수 없습니다.")) {
        return;
    }

    fetch('/delete_account', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ password: password })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '/'; 
        } else {
            errorMsg.innerText = data.message;
            pwInput.value = ''; 
            pwInput.focus();
            btn.classList.add('error-shake');
            setTimeout(() => btn.classList.remove('error-shake'), 300);
        }
    })
    .catch(err => {
        alert("처리 중 오류가 발생했습니다.");
    });
}

function closeBlockModal() {
    document.getElementById('deleteBlockModal').style.display = 'none';
    openTab({currentTarget: document.querySelector("button[onclick*='sub-tab']")}, 'sub-tab');
}

document.getElementById('del_pw').addEventListener('input', function() {
    const btn = document.querySelector('#del-tab .setting-confirm-btn');
    if(this.value.length > 0) {
        btn.style.backgroundColor = '#E50914';
        btn.style.color = '#fff';
        btn.style.border = 'none';
    } else {
        btn.style.backgroundColor = '#333';
        btn.style.color = '#aaa';
        btn.style.border = '1px solid #555';
    }
});
</script>
</html>