{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAIS - My Videos</title>
    <link rel="icon" href="{% static 'images/logo.png' %}" type="image/x-icon"> 
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="main-body"> 
{% include 'layout/header.html' %}

<div class="my-video-container">
    {% if video_list %}
        <div class="my-video-grid-wrapper">
            <h2 class="section-title">내 영상 보관함</h2>
            
            <div class="my-video-grid">
                {% for video in video_list %}
                    {% with status=video.upload_status_code.common_code %}
                    
                    <div class="my-video-card" id="card-{{ video.id }}"
                        {% if status == '22' %}
                            onclick="location.href='{% url 'videos:play_user_video' video.id %}'"
                            style="cursor: pointer;"
                        {% else %}
                            style="cursor: default;" 
                        {% endif %}>

                        <div class="mv-thumb-box">
                            
                            {% if status == '20' or status == '21' %}
                                <div class="processing-overlay">
                                    <video src="{{ video.url }}" muted></video> 
                                    <div class="proc-msg">
                                        {% if status == '20' %}대기 중..{% else %}영상 분석 중..{% endif %}
                                    </div>
                                    <div class="proc-bar-bg"><div class="proc-bar-fill"></div></div>
                                </div>

                            {% elif status == '23' %}
                                <div class="processing-overlay error-overlay">
                                    <div class="proc-msg error-msg" style="color: #ff6b6b; font-weight: bold;">
                                        ⚠️ 분석 실패
                                    </div>
                                    <div class="hover-actions" style="opacity: 1; justify-content: center;">
                                        <button class="action-btn delete" onclick="event.stopPropagation(); openDeleteModal('{{ video.id }}')" title="영상 삭제">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                            {% elif status == '22' %}
                                <video src="{{ video.url }}" muted onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
                                <div class="hover-actions">
                                    <button class="action-btn download" 
                                            data-count="{{ video.download_count }}"
                                            onclick="event.stopPropagation(); openDownloadModal(this, '{{ video.id }}', '{{ video.title }}')" 
                                            title="영상 다운로드">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                        </svg>
                                    </button>
                                    <button class="action-btn delete" onclick="event.stopPropagation(); openDeleteModal('{{ video.id }}')" title="영상 삭제">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
                
                <div class="my-video-card add-new-card" onclick="openUploadModal()">
                    <div class="add-icon-circle">+</div>
                    <p>새 영상 업로드</p>
                </div>
            </div>
        </div>

    {% else %}
        <div class="welcome-box">
            <h1 class="welcome-title">모든 순간에는 해설이 필요하니까.</h1>
            <p class="welcome-desc">
                그날의 경기, 그 순간의 전율을 AI 해설과 함께 다시 느껴보세요.<br>
                BAIS가 당신의 평범한 영상을 한 편의 드라마로 바꿔드립니다.<br>
                영상 업로드 버튼을 눌러, 그 시작을 함께하세요.
            </p>
            <div class="welcome-info">
                잠깐! 구독 플랜에 따라 올릴 수 있는 용량이 정해져 있어요.<br>
                더욱 강력한 퍼포먼스가 필요하다면 구독 정보를 확인해 주세요.
            </div>
            <button class="upload-start-btn" onclick="openUploadModal()">
                영상 업로드
            </button>
        </div>
    {% endif %}
</div>

<div id="uploadModal" class="modal-overlay" style="display: none;">
    <div class="upload-modal-box">
        <span class="close-btn" onclick="closeUploadModal()">&times;</span>
        
        <h2 class="upload-modal-title">영상 업로드</h2>

        <form action="{% url 'videos:upload' %}" method="POST" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <div class="upload-section">
                <label class="upload-label">파일 선택</label>
                <div class="file-input-wrapper">
                    <input type="text" id="fileNameDisplay" placeholder="업로드할 동영상 파일을 선택해주세요." readonly>
                    <label for="videoFile" class="file-select-btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 16L12 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 11L12 8 15 11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 19V11C22 9.89543 21.1046 9 20 9H13L11 7H4C2.89543 7 2 7.89543 2 9V19C2 20.1046 2.89543 21 4 21H20C21.1046 21 22 20.1046 22 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </label>
                    <input type="file" name="video_file" id="videoFile" accept=".mp4" style="display: none;" onchange="handleFileSelect(this)">
                </div>
                
                <div class="storage-info">
                    <span class="storage-text">저장 공간 현황 : {{ storage_display }}</span>
                    <div class="storage-bar-bg">
                        <div class="storage-bar-fill" style="width: {{ used_percentage }}%;"></div>
                    </div>
                </div>
                <p id="sizeErrorMsg" class="error-text" style="display: none;">용량이 부족해 업로드할 수 없습니다.</p>
            
                <label class="upload-label" style="margin-top: 25px;">해설위원 선택</label>
                <input type="hidden" name="commentator" id="selectedCommentator"> 
                <div class="comm-card-container" style="margin-bottom: 25px;">
                    <div class="comm-card" onclick="selectUploadComm(this, '박찬오')">
                        <div class="comm-header">박찬오 해설위원</div>
                        <div class="comm-img-box">
                            <img src="{% static 'images/commentator/park.svg' %}" alt="박찬오">
                        </div>
                        <div class="comm-desc">
                            한국 야구의 레전드,<br>끝없는 야구 철학!<br>
                            풍부한 경험담과 열정이 넘치는 TMT 해설
                        </div>
                    </div>

                    <div class="comm-card" onclick="selectUploadComm(this, '이순칠')">
                        <div class="comm-header">이순칠 해설위원</div>
                        <div class="comm-img-box">
                            <img src="{% static 'images/commentator/lee.svg' %}" alt="이순칠">
                        </div>
                        <div class="comm-desc">
                            가감 없는 쓴소리와<br>날카로운 비판,<br>
                            데이터에 기반한 객관적이고 시원시원한 해설
                        </div>
                    </div>

                    <div class="comm-card" onclick="selectUploadComm(this, '김선오')">
                        <div class="comm-header">김선오 해설위원</div>
                        <div class="comm-img-box">
                            <img src="{% static 'images/commentator/kim.svg' %}" alt="김선오">
                        </div>
                        <div class="comm-desc">
                            메이저리그 경험을 녹여낸 세련되고 부드러운 분석,<br>
                            디테일한 해설을 제공하는<br>입문자 맞춤 해설
                        </div>
                    </div>
                </div>

                <div class="upload-section">
                    <label class="upload-label">영상 제목</label>
                    <input type="text" name="video_title" id="videoTitle" class="upload-text-input" placeholder="제목을 입력하세요" oninput="checkUploadForm()">
                </div>

                <button type="submit" class="upload-confirm-btn" id="uploadBtn" disabled>
                    영상 업로드하기
                </button>
            </div>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal-overlay" style="display: none; z-index: 2000;">
    <div class="confirm-modal-box">
        <span class="close-btn" onclick="closeConfirmModal()">&times;</span>
        
        <h2 class="confirm-title">영상 업로드 최종 확인</h2>
        
        <div class="confirm-content">
            <p class="confirm-main-text">파일을 업로드 하시겠습니까?</p>
            
            <ul class="confirm-list">
                <li>파일을 업로드 하는 동안 본 화면에서 벗어날 수 없습니다.</li>
                <li>영상 업로드하기를 실행할 경우 중간에 취소가 불가능합니다.</li>
            </ul>

            <div class="warning-box">
                <strong class="warning-title">⚠️ 업로드 전 필수 체크사항</strong>
                <ul class="warning-list">
                    <li><strong>음성 데이터 필수:</strong> 음성이 없는 영상은 AI 해설 생성이 어렵습니다.</li>
                    <li><strong>스코어보드 포함:</strong> 화면 내 스코어보드가 없으면 정확한 상황 인식이 제한될 수 있습니다.</li>
                    <li><strong>종목 제한:</strong> 현재 베타 테스트 기간으로 <span>야구 영상만 지원</span>하며, 추후 농구/축구 등으로 확대 예정입니다.</li>
                </ul>
            </div>
        </div>

        <button type="button" class="final-upload-btn" onclick="submitUploadForm()">
            영상 업로드하기
        </button>
    </div>
</div>

<div id="downloadModal" class="modal-overlay" style="display: none; z-index: 3000;">
    <div class="upload-modal-box download-theme"> <span class="close-btn" onclick="closeDownloadModal()">&times;</span>
        
        <h2 class="confirm-title">영상 다운로드</h2>
        
        <div class="confirm-content">
            <p class="confirm-main-text" id="dl-video-title">영상 제목</p>
            
            <p class="confirm-desc-text">
                해당 영상을 로컬 저장소로 다운로드 하시겠습니까?<br>
                다운로드 시간은 네트워크 환경 및 파일 크기에 따라 상이할 수 있습니다.
            </p>

            <div class="count-info-box">
                <span class="count-label">다운로드 가능 횟수 (남은 횟수 / 총 횟수)</span>
                <span class="count-value" id="dl-count-display">확인 중...</span>
            </div>
        </div>

        <button type="button" class="final-upload-btn" id="realDownloadBtn" onclick="executeDownload()">
            영상 다운로드하기
        </button>
    </div>
</div>

<div id="deleteModal" class="modal-overlay" style="display: none; z-index: 3000;">
    <div class="upload-modal-box delete-theme">
        <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
        
        <h2 class="confirm-title">영상 삭제</h2>
        
        <div class="confirm-content">
            <p class="confirm-main-text">선택하신 영상을 영구 삭제하시겠습니까?</p>
            
            <p class="warn-desc-text">
                삭제된 영상은 시스템에서 즉시 파기되며 복구가 불가능합니다.<br>
                연결된 AI 분석 데이터 및 자막 정보도 함께 삭제됩니다.
            </p>
        </div>

        <button type="button" class="final-upload-btn delete-confirm-btn" id="realDeleteBtn" onclick="executeDelete()">
            영상 삭제하기
        </button>
    </div>
</div>
{% include 'layout/footer.html' %}
</body>
<script>
const remainingBytes = Number("{{ remaining_bytes|default:0 }}");

function openUploadModal() { 
    document.getElementById('uploadModal').style.display = 'flex'; 
    checkUploadForm();
}

function closeUploadModal() { 
    document.getElementById('uploadModal').style.display = 'none'; 
    document.getElementById('uploadForm').reset();
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

function handleFileSelect(input) {
    const file = input.files[0];
    const display = document.getElementById('fileNameDisplay');
    const errorMsg = document.getElementById('sizeErrorMsg');

    if (file) {
        if (remainingBytes > 0 && file.size > remainingBytes) {
            display.value = "";
            input.value = "";
            errorMsg.style.display = 'block';
            
            const fileSizeGB = (file.size / (1024 * 1024 * 1024)).toFixed(2);
            const remainGB = (remainingBytes / (1024 * 1024 * 1024)).toFixed(2);
            errorMsg.innerText = `용량 부족! (파일: ${fileSizeGB}GB / 남은: ${remainGB}GB)`;
        } else {
            display.value = file.name;
            errorMsg.style.display = 'none';
        }
    } else {
        display.value = ""; 
    }
    checkUploadForm(); 
}

function selectUploadComm(element, name) {
    document.querySelectorAll('.comm-card').forEach(c => c.classList.remove('selected'));
    element.classList.add('selected');
    document.getElementById('selectedCommentator').value = name;
    
    checkUploadForm(); 
}

function checkUploadForm() {
    const fileInput = document.getElementById('videoFile');
    const hasFile = fileInput.files.length > 0;
    
    const commValue = document.getElementById('selectedCommentator').value;
    const hasComm = commValue && commValue.trim() !== "";
    
    const titleValue = document.getElementById('videoTitle').value;
    const hasTitle = titleValue && titleValue.trim() !== "";

    const btn = document.getElementById('uploadBtn');

    if (hasFile && hasComm && hasTitle) {
        btn.disabled = false;
    } else {
        btn.disabled = true; 
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    if (form) {
        checkUploadForm();

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            document.getElementById('confirmModal').style.display = 'flex';
        });
    }
});

async function submitUploadForm() {
    const form = document.getElementById('uploadForm');
    const btn = document.querySelector('.final-upload-btn');
    const closeBtn = document.querySelector('#confirmModal .close-btn');
    const modalBox = document.querySelector('.confirm-modal-box');
    const modalOverlay = document.getElementById('confirmModal');
    
    if (form) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> 업로드 및 분석 중...';
        btn.style.backgroundColor = "#444";
        
        if (closeBtn) closeBtn.style.display = 'none'; 
        if (modalBox) modalBox.style.cursor = 'wait'; 
        if (modalOverlay) modalOverlay.style.zIndex = '10000';

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                btn.innerHTML = '✅ 업로드 완료!';
                btn.style.backgroundColor = "#E50914";
                
                setTimeout(() => {
                    closeConfirmModal();
                    closeUploadModal();
                    location.reload(); 
                }, 1000);

            } else {
                throw new Error(data.message || "업로드 실패");
            }

        } catch (error) {
            alert("오류 발생: " + error.message);
            
            btn.disabled = false;
            btn.innerText = "영상 업로드하기";
            btn.style.backgroundColor = "#E50914";
            btn.style.cursor = "pointer";

            if (closeBtn) closeBtn.style.display = 'block';
            if (modalBox) modalBox.style.cursor = 'default';
            if (modalOverlay) modalOverlay.style.zIndex = '';
        }
    }
}

let targetVideoId = null;
let currentDownloadBtn = null; 

function openDownloadModal(btnElement, id, title) {
    targetVideoId = id;
    currentDownloadBtn = btnElement; 
    
    document.getElementById('dl-video-title').innerText = title;
    
    const currentCount = parseInt(btnElement.getAttribute('data-count'));
    
    const totalLimit = 10;
    const remaining = totalLimit - currentCount;
    const safeRemaining = remaining < 0 ? 0 : remaining;

    document.getElementById('dl-count-display').innerText = `${safeRemaining} / ${totalLimit}`;
    
    const btn = document.getElementById('realDownloadBtn');
    if (safeRemaining <= 0) {
        btn.disabled = true;
        btn.innerText = "다운로드 횟수 초과";
        btn.style.backgroundColor = "#555";
        btn.style.cursor = "not-allowed";
    } else {
        btn.disabled = false;
        btn.innerText = "영상 다운로드하기";
        btn.style.backgroundColor = "#E50914";
        btn.style.cursor = "pointer";
    }

    document.getElementById('downloadModal').style.display = 'flex';
}

function closeDownloadModal() {
    document.getElementById('downloadModal').style.display = 'none';
    targetVideoId = null;
    currentDownloadBtn = null;
}

async function executeDownload() {
    if (!targetVideoId) return;
    
    const btn = document.getElementById('realDownloadBtn');
    btn.disabled = true;
    btn.innerText = "다운로드 처리 중...";

    try {
        const response = await fetch(`/videos/myvideos/download/${targetVideoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();

        if (response.ok && data.status === 'success') {
            const link = document.createElement('a');
            link.href = data.file_url;
            link.download = ''; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const newRemaining = data.remaining_count;
            document.getElementById('dl-count-display').innerText = `${newRemaining} / 10`;
            
            if (currentDownloadBtn) {
                currentDownloadBtn.setAttribute('data-count', data.current_count);
            }

            btn.innerText = "다운로드 시작됨";
            
            setTimeout(() => { 
                closeDownloadModal(); 
                btn.disabled = false; 
                btn.innerText = "영상 다운로드하기"; 
            }, 1000);

        } else if (data.status === 'limit_exceeded') {
            alert(data.message);
            closeDownloadModal();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        alert("오류: " + error.message);
        btn.disabled = false;
        btn.innerText = "영상 다운로드하기";
    }
}

function openDeleteModal(id) {
    targetVideoId = id;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    targetVideoId = null;
}

async function executeDelete() {
    if (!targetVideoId) {
        alert("삭제할 대상 ID가 없습니다.");
        return;
    }

    console.log("삭제 시도 ID:", targetVideoId);
    console.log("찾으려는 DOM ID:", `card-${targetVideoId}`);
    
    const cardToDelete = document.getElementById(`card-${targetVideoId}`);
    console.log("찾은 요소:", cardToDelete); 

    const btn = document.getElementById('realDeleteBtn');
    btn.disabled = true;
    btn.innerText = "삭제 중...";

    try {
        const response = await fetch(`/videos/myvideos/delete/${targetVideoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (response.ok && data.status === 'success') {
            closeDeleteModal();

            if (cardToDelete) {
                cardToDelete.style.transition = "all 0.5s ease";
                cardToDelete.style.opacity = "0";
                cardToDelete.style.transform = "scale(0.8)";
                cardToDelete.style.height = "0";
                cardToDelete.style.margin = "0";
                cardToDelete.style.overflow = "hidden"; 

                setTimeout(() => {
                    cardToDelete.remove();
                    
                    const remaining = document.querySelectorAll('.my-video-card:not(.add-new-card)').length;
                    if (remaining === 0) location.reload();
                }, 500);
            } else {
                console.error("HTML에서 삭제할 카드 요소를 찾지 못했습니다! id 속성을 확인하세요.");
                location.reload();
            }

        } else {
            throw new Error(data.message || "삭제 실패");
        }

    } catch (error) {
        alert("오류 발생: " + error.message);
        btn.disabled = false;
        btn.innerText = "영상 삭제하기";
    }
}
</script>
</html>